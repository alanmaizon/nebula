name: Deploy Cloud Run

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  ARTIFACT_REPOSITORY: ${{ secrets.GCP_ARTIFACT_REPOSITORY }}
  BACKEND_SERVICE: nebula-backend
  FRONTEND_SERVICE: nebula-frontend

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check deploy configuration
        id: config
        run: |
          if [ -z "${{ secrets.GCP_PROJECT_ID }}" ] || \
             [ -z "${{ secrets.GCP_REGION }}" ] || \
             [ -z "${{ secrets.GCP_ARTIFACT_REPOSITORY }}" ] || \
             [ -z "${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}" ] || \
             [ -z "${{ secrets.GCP_SERVICE_ACCOUNT }}" ]; then
            echo "enabled=false" >> "${GITHUB_OUTPUT}"
            echo "Skipping deploy because required GCP secrets are not configured."
          else
            echo "enabled=true" >> "${GITHUB_OUTPUT}"
          fi

      - name: Authenticate to Google Cloud
        if: ${{ steps.config.outputs.enabled == 'true' }}
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        if: ${{ steps.config.outputs.enabled == 'true' }}
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure docker auth for Artifact Registry
        if: ${{ steps.config.outputs.enabled == 'true' }}
        run: gcloud auth configure-docker "${GCP_REGION}-docker.pkg.dev" --quiet

      - name: Build and push backend image
        if: ${{ steps.config.outputs.enabled == 'true' }}
        run: |
          BACKEND_IMAGE="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REPOSITORY}/nebula-backend:${GITHUB_SHA}"
          docker build -t "${BACKEND_IMAGE}" backend
          docker push "${BACKEND_IMAGE}"
          echo "BACKEND_IMAGE=${BACKEND_IMAGE}" >> "${GITHUB_ENV}"

      - name: Deploy backend to Cloud Run
        if: ${{ steps.config.outputs.enabled == 'true' }}
        run: |
          gcloud run deploy "${BACKEND_SERVICE}" \
            --project "${GCP_PROJECT_ID}" \
            --region "${GCP_REGION}" \
            --platform managed \
            --image "${BACKEND_IMAGE}" \
            --allow-unauthenticated \
            --set-env-vars "APP_ENV=production,CORS_ORIGINS=*" \
            --quiet

          BACKEND_URL="$(gcloud run services describe "${BACKEND_SERVICE}" --project "${GCP_PROJECT_ID}" --region "${GCP_REGION}" --format 'value(status.url)')"
          echo "BACKEND_URL=${BACKEND_URL}" >> "${GITHUB_ENV}"

      - name: Build and push frontend image
        if: ${{ steps.config.outputs.enabled == 'true' }}
        run: |
          FRONTEND_IMAGE="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REPOSITORY}/nebula-frontend:${GITHUB_SHA}"
          docker build \
            --build-arg NEXT_PUBLIC_API_BASE="${BACKEND_URL}" \
            -t "${FRONTEND_IMAGE}" \
            frontend
          docker push "${FRONTEND_IMAGE}"
          echo "FRONTEND_IMAGE=${FRONTEND_IMAGE}" >> "${GITHUB_ENV}"

      - name: Deploy frontend to Cloud Run
        if: ${{ steps.config.outputs.enabled == 'true' }}
        run: |
          gcloud run deploy "${FRONTEND_SERVICE}" \
            --project "${GCP_PROJECT_ID}" \
            --region "${GCP_REGION}" \
            --platform managed \
            --image "${FRONTEND_IMAGE}" \
            --allow-unauthenticated \
            --quiet

      - name: Output deployment URLs
        if: ${{ steps.config.outputs.enabled == 'true' }}
        run: |
          FRONTEND_URL="$(gcloud run services describe "${FRONTEND_SERVICE}" --project "${GCP_PROJECT_ID}" --region "${GCP_REGION}" --format 'value(status.url)')"
          echo "Backend URL: ${BACKEND_URL}"
          echo "Frontend URL: ${FRONTEND_URL}"
