name: CodeQL

on:
  push:
    branches:
      - main
  pull_request:
  schedule:
    - cron: "0 5 * * 1"

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language:
          - python
          - javascript-typescript

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect source files for selected language
        id: detect
        shell: bash
        run: |
          if [[ "${{ matrix.language }}" == "python" ]]; then
            if git ls-files '*.py' | grep -q .; then
              echo "has_source=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_source=false" >> "$GITHUB_OUTPUT"
            fi
          elif [[ "${{ matrix.language }}" == "javascript-typescript" ]]; then
            if git ls-files '*.js' '*.jsx' '*.mjs' '*.cjs' '*.ts' '*.tsx' | grep -q .; then
              echo "has_source=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_source=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "has_source=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip language with no source files
        if: steps.detect.outputs.has_source != 'true'
        run: echo "No source files found for ${{ matrix.language }}. Skipping CodeQL analysis."

      - name: Check whether GitHub Code Scanning is enabled
        id: code_scanning
        if: steps.detect.outputs.has_source == 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          api_url="https://api.github.com/repos/${{ github.repository }}/code-scanning/alerts?per_page=1"
          http_code="$(curl -sS -o response.json -w "%{http_code}" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "$api_url")"

          if [[ "$http_code" == "200" ]]; then
            echo "enabled=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "$http_code" == "403" ]] && grep -q "Code scanning is not enabled" response.json; then
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ "$http_code" == "404" ]]; then
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Unexpected response when checking code scanning: HTTP $http_code"
          cat response.json
          exit 1

      - name: Skip because code scanning is disabled
        if: steps.detect.outputs.has_source == 'true' && steps.code_scanning.outputs.enabled != 'true'
        run: echo "GitHub Code Scanning is not enabled for this repository. Skipping CodeQL upload."

      - name: Initialize CodeQL
        if: steps.detect.outputs.has_source == 'true' && steps.code_scanning.outputs.enabled == 'true'
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      - name: Autobuild
        if: steps.detect.outputs.has_source == 'true' && steps.code_scanning.outputs.enabled == 'true'
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        if: steps.detect.outputs.has_source == 'true' && steps.code_scanning.outputs.enabled == 'true'
        uses: github/codeql-action/analyze@v3
