name: Deploy AWS

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_BACKEND_REPOSITORY: ${{ secrets.ECR_BACKEND_REPOSITORY }}
  ECR_FRONTEND_REPOSITORY: ${{ secrets.ECR_FRONTEND_REPOSITORY }}
  ECS_CLUSTER: ${{ secrets.ECS_CLUSTER }}
  ECS_BACKEND_SERVICE: ${{ secrets.ECS_BACKEND_SERVICE }}
  ECS_FRONTEND_SERVICE: ${{ secrets.ECS_FRONTEND_SERVICE }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check deploy configuration
        id: config
        run: |
          if [ -z "${{ secrets.AWS_REGION }}" ] || \
             [ -z "${{ secrets.AWS_ROLE_TO_ASSUME }}" ] || \
             [ -z "${{ secrets.ECR_BACKEND_REPOSITORY }}" ] || \
             [ -z "${{ secrets.ECR_FRONTEND_REPOSITORY }}" ] || \
             [ -z "${{ secrets.ECS_CLUSTER }}" ] || \
             [ -z "${{ secrets.ECS_BACKEND_SERVICE }}" ] || \
             [ -z "${{ secrets.ECS_FRONTEND_SERVICE }}" ]; then
            echo "enabled=false" >> "${GITHUB_OUTPUT}"
            echo "Skipping deploy because required AWS secrets are not configured."
          else
            echo "enabled=true" >> "${GITHUB_OUTPUT}"
          fi

      - name: Configure AWS credentials
        if: ${{ steps.config.outputs.enabled == 'true' }}
        uses: aws-actions/configure-aws-credentials@v6
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}

      - name: Login to Amazon ECR
        if: ${{ steps.config.outputs.enabled == 'true' }}
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Resolve image names
        if: ${{ steps.config.outputs.enabled == 'true' }}
        run: |
          REGISTRY="${{ steps.ecr.outputs.registry }}"
          BACKEND_IMAGE="${REGISTRY}/${ECR_BACKEND_REPOSITORY}:${GITHUB_SHA}"
          BACKEND_IMAGE_LATEST="${REGISTRY}/${ECR_BACKEND_REPOSITORY}:latest"
          FRONTEND_IMAGE="${REGISTRY}/${ECR_FRONTEND_REPOSITORY}:${GITHUB_SHA}"
          FRONTEND_IMAGE_LATEST="${REGISTRY}/${ECR_FRONTEND_REPOSITORY}:latest"
          echo "BACKEND_IMAGE=${BACKEND_IMAGE}" >> "${GITHUB_ENV}"
          echo "BACKEND_IMAGE_LATEST=${BACKEND_IMAGE_LATEST}" >> "${GITHUB_ENV}"
          echo "FRONTEND_IMAGE=${FRONTEND_IMAGE}" >> "${GITHUB_ENV}"
          echo "FRONTEND_IMAGE_LATEST=${FRONTEND_IMAGE_LATEST}" >> "${GITHUB_ENV}"

      - name: Build and push backend image
        if: ${{ steps.config.outputs.enabled == 'true' }}
        run: |
          docker build -t "${BACKEND_IMAGE}" backend
          docker tag "${BACKEND_IMAGE}" "${BACKEND_IMAGE_LATEST}"
          docker push "${BACKEND_IMAGE}"
          docker push "${BACKEND_IMAGE_LATEST}"

      - name: Build and push frontend image
        if: ${{ steps.config.outputs.enabled == 'true' }}
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_API_BASE="${{ secrets.NEXT_PUBLIC_API_BASE }}" \
            -t "${FRONTEND_IMAGE}" \
            frontend
          docker tag "${FRONTEND_IMAGE}" "${FRONTEND_IMAGE_LATEST}"
          docker push "${FRONTEND_IMAGE}"
          docker push "${FRONTEND_IMAGE_LATEST}"

      - name: Roll out ECS services
        if: ${{ steps.config.outputs.enabled == 'true' }}
        run: |
          aws ecs update-service \
            --cluster "${ECS_CLUSTER}" \
            --service "${ECS_BACKEND_SERVICE}" \
            --force-new-deployment
          aws ecs update-service \
            --cluster "${ECS_CLUSTER}" \
            --service "${ECS_FRONTEND_SERVICE}" \
            --force-new-deployment

      - name: Wait for ECS services stability
        if: ${{ steps.config.outputs.enabled == 'true' }}
        run: |
          aws ecs wait services-stable \
            --cluster "${ECS_CLUSTER}" \
            --services "${ECS_BACKEND_SERVICE}" "${ECS_FRONTEND_SERVICE}"
          echo "Deployment completed for ECS services:"
          echo "- ${ECS_BACKEND_SERVICE}"
          echo "- ${ECS_FRONTEND_SERVICE}"
